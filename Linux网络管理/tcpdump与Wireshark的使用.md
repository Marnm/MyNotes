---
title: tcpdump与Wireshark的使用
tags:
  - tcpdump
  - wireshark
---

### tcpdump 
> 一款sniffer工具，是Linux上的抓包工具，嗅探器

**选项**
```
-a: 尝试将网络和广播地址转换成名称；
-c<数据包数目>：收到指定的数据包数目后，就停止进行倾倒操作；
-d：把编译过的数据包编码转换成可阅读的格式，并倾倒到标准输出；
-dd：把编译过的数据包编码转换成C语言格式，并倾倒到标准输出；
-ddd：把编译过的数据包编码转换成十进制数字的格式，并倾倒到标准输出；
-e：在每列倾倒资料上显示连接层级的文件头；
-f：用数字显示网际网络地址；
-F<表达文件>：指定内含表达方式的文件；
-i<网络界面>：使用指定的网络截面送出数据包；
-l：使用标准输出列的缓冲区；
-n：不把主机的网络地址转换成名字；
-N：不列出域名；
-O：不将数据包编码最佳化；
-p：不让网络界面进入混杂模式；
-q：快速输出，仅列出少数的传输协议信息；
-r<数据包文件>：从指定的文件读取数据包数据；
-s<数据包大小>：设置每个数据包的大小；
-S：用绝对而非相对数值列出TCP关联数；
-t：在每列倾倒资料上显示时间戳记；
-tt：在每列倾倒资料上显示未经格式化的时间戳记；
-T<数据包类型>：强制将表达方式所指定的数据包转译成设置的数据包类型
-v：详细显示指令执行过程
-vv：更详细显示指令执行过程
-x：用十六进制码列出数据包资料；
-w<数据包文件>：把数据包数据写入指定的文件。
```

----
> `[S]`: SYN(开始连接)
> `[.]`:没有Flag，（由于除了SYN包外所有的数据包都有ACK，所以一般这个标志也可表示ACK）
> `[P]`: PSH(推送数据
> `[F]`: FIN(结束连接
> `[R]`: RST(重置连接
> `[S.]`: 表示SYN-ACK，就是SYN报文的应答报文

```
21:27:06.995846 IP (tos 0x0, ttl 64, id 45646, offset 0, flags [DF], proto TCP (6), length 64)    
192.168.1.110.40411 > 192.168.1.123.80: Flags [S], cksum 0xa730 (correct), seq 992042666, win 65535, options [mss 1460,nop,wscale 4,nop,nop,TS val 663433143 ecr 0,sackOK,eol], length 0
21:27:07.030487 IP (tos 0x0, ttl 51, id 0, offset 0, flags [DF], proto TCP (6), length 44)    
192.168.1.123.80 > 192.168.1.110.40411: Flags [S.], cksum 0xedc0 (correct), seq 2147006684, ack 992042667, win 14600, options [mss 1440], length 021:27:07.030527 IP (tos 0x0, ttl 64, id 59119, offset 0, flags [DF], proto TCP (6), length 40)    
192.168.1.110.40411 > 192.168.1.123.80: Flags [.], cksum 0x3e72 (correct), ack 2147006685, win 65535, length 0
```
**格式解读**
- 192.168.1.110.40411
    - 源地址IP.源端口
    
- 192.168.1.123.80
    - 目的地址.目的端口

- `>`
    - 代表数据的方向


#### 数据包分析
```bash
tcpdump -ntx -c 1
# -n 显示IP地址而非域名地址
# -t 不显示时间戳
# -x 以十六进制显示包内容
# -c tcpdump将在接受1个数据包后退出
```
.png

192.168.73.10.ssh > 192.168.73.1.13229表示：
源ip 192.168.73.10，服务/端口ssh;
目的ip 192.168.73.1，服务/端口13229

**看到0x000行**
- 协议版本：第一个数字为4，表示0x4。即协议版本是IPv4
    常见的一些协议相应字段值

| 协议名 | ICMP | IGMP | IP | TCP | EGP | IGP | UDP | IPv6 | ESP | OSPF |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 协议字段值 | 1 | 2 | 4 | 6 | 8 | 9 | 17 | 41 | 50 | 89 |
- 首部长度：第二个数字为5，表示0x5。5\*4=20（十六进制1位对应二进制4位），表示IP报头长度为20字节。一个字节通常等于8位，所以IP报头为4510到4901
.png

- 服务类型TOS：0x00，意味着是一般服务
- 总长度：0x00ec，换算成十进制为236字节。
- 标识：0x5175
- 3bit标志+13bit片偏移：0x4000
- 生存时间：0x40，十进制值为64
- 协议：0x06 代表TCP协议
首部校验和：0xd52a



### Wireshark的使用

**通过tcpdump抓包导出pcap文件**
```bash
tcpdump -i ens33 icmp and host 192.167.73.100 -w ping.pcap
```
**使用wireshark打开输出的文件**
.png




参考：[实战！我用 Wireshark 让你“看见“ TCP](https://www.cnblogs.com/xiaolincoding/p/12922927.html)
