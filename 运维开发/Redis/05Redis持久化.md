---
title: 05Redis持久化
tags: []
---

# Redis持久化

默认情况下，Redis工作时所有数据都集都是存储与内存中的，不论是否有磁盘上的持久化数据，都是工作于内存当中，redis本身就是一个内存的数据库，把所有数据库相关的存储都存储在内存中，如果redis崩溃或断电导致所有数据丢失，所以redis提供了持久化功能来保证数据的可靠性，redis持久化有两种实现方式。RDB和AOF

## RDB

RDB存储为二进制格式的数据文件，默认启动的持久化机制，按事先指定的策略，周期性地将数据保存至磁盘，使用save命令即可设定周期和策略即可；数据文件默认为dump.rdb，客户端连接服务器可以用save命令进行保存至数据至磁盘。

**保存快照有两种方式**

1、客户端也可显式使用`SAVE`和`BGSAVE`命令启动快照保存机制；  
2、借助于配置文件所定义的save和策略进行保存；

**SAVE：** 是同步保存，在客户端使用save保存快照时，是在redis主线程中保存快照；因为redis的主线程是用于处理请求的，所以此时会阻塞所有客户端请求，每次的保存快照都是把内存中的数据完整的保存一份，并非是增量的，如果内存中的数据比较大，而还有大量的写操作时，此方式会引起大量的I/O，会导致redis性能下降

**BGSAVE：** 异步方式，将立即返回结果，但自动在后台保持操作，所以BGSAVE命令启动以后，前台不会被占用，客户端的请求是不会被阻塞（主进程不会被阻塞）

如果是在配置文件中定义的save，那么redis在持久化的时候，则会开启另外的进程去处理，不会阻塞redis的主进程

RDB持久化不足之处则是，一旦数据出现问题，由于RDB的数据不是最新的，所以基于RDB恢复过来的数据一定会有一部分数据丢失，也就是RDB保存之后的修改数据会丢失。

## AOF

**AOF：** Append Only File，有着更好的持久化能力解决方案，AOF类似于MySQL的二进制日志，记录每一次Redis的写操作命令，以顺序IO方式附加在指定文件的尾部，是使用追加方式实现的，这也叫做一种**附加日志**类型的持久化机制，由于每一次的操纵都记录，则会随着时间增长而增大文件的容量，并且有些记录的命令是多余的，AOF不像RDB，RDB是保存数据集的本身

但是Redis进程能够自动的去扫描这个对应的AOF文件，把其中一些冗余的操作给合并成一个，以实现将来一次性把数据恢复，也就是说Redis能够合并重写AOF的持久化文件，由BGREWRITEAOF命令来实现，BGREWIRTEAOF命令是工作于后台的重写AOF文件的命令，重写后Redis将会以快照的方式将内存中的数据以命令方式保存在临时文件中，最后替换原来的文件，重写AOF文件方式，并没有读取旧AOF文件，而是直接将当前内存中的所有数据直接生成一个类似于MySQL二进制日志命令一样的操作。
